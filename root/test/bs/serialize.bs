use lang:bs;
use lang:bs:macro;
use core:io;

/**
 * Serializable class.
 */
class Data : persist {
	Int a;
	Int b;
	Employee data1;
	Employee data2;

	init() {
		init() {
			a = 5;
			b = 8;
			data1 = Employee();
			data2 = Manager();
		}
	}

	// Write. Should be automatically generated...
	void write(ObjOStream to) {
		var mode = to.startObject(this);
		if (mode & Serialize:members) {
			// TODO: Parent class.
			to.member("a", named{core:Int});
			to.member("b", named{core:Int});
			// to.member("data1", named{Employee});
			// to.member("data2", named{Employee});
			to.endMembers();
		}
		if (mode & Serialize:body) {
			// TODO: Parent class.
			a.write(to);
			b.write(to);
			// data1.write(to);
			// data2.write(to);
			to.endBody();
		}
	}

	// Read. Should be automatically generated...
	// static Data read(ObjIStream from) {
	// 	// TODO: How do we handle inheritance?
	// 	var mode = from.startObject();
	// 	if (mode & Serialize:members) {
	// 		from.member("a", named{core:Int});
	// 		from.member("b", named{core:Int});
	// 		from.member("c", named{core:Bool});
	// 		from.member("data", named{Employee});
	// 		from.endMembers();
	// 	}
	// 	if (mode & Serialize:body) {
	// 		// Create an instance of the object and load data from it.
	// 	} else {
	// 		// Retrieve a previously stored object.
	// 	}
	// }
}

/**
 * Another serializable class.
 */
class Employee {
	Str name;
	Int coolness;

	init() {
		init() { name = "John Smith"; coolness = 500; }
	}

	void write(ObjOStream to) {
		var mode = to.startObject(this);
		if (mode & Serialize:members) {
			to.member("name", named{core:Str});
			to.member("coolness", named{core:Int});
			to.endMembers();
		}
		if (mode & Serialize:body) {
			name.write(to);
			coolness.write(to);
			to.endBody();
		}
	}
}

/**
 * A sub-class to Employee.
 */
class Manager extends Employee {
	Str title;

	init() {
		init() { title = "Manager"; }
		name = "Mr. " # name;
		coolness *= 10;
	}

	void write(ObjOStream to) {
		var mode = to.startObject(this);
		if (mode & Serialize:members) {
			to.parent(named{Employee});
			super:write(to);
			to.member("title", named{core:Str});
			to.endMembers();
		}
		if (mode & Serialize:body) {
			super:write(to);
			title.write(to);
			to.endBody();
		}
	}
}


// Persist decorator
void persist(Class c) {
	print("Decorator: " # c);
}

// Test serialization.
void testSerialize() {
	Data x;
	MemOStream out;
	ObjOStream obj(out);

	x.write(obj);
	print("Raw data\n" # out);

	MemIStream in(out.buffer);
	util:TextObjStream read(in);
	print("Result: " # read.read());
}
